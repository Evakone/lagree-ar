<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LCS+E AR Experience</title>

  <!-- Brand font - Zen Kaku Gothic New -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@^3.0.0/dist/model-viewer.min.js"></script>

  <style>
    :root {
      --color-black: #000;
      --color-white: #fff;
      --spacing-sm: .5rem;
      --spacing-md: .75rem;
      --spacing-lg: 1rem;
      --radius-md: 10px;
      --z-fixed: 10;
      --font: 'Zen Kaku Gothic New', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html, body { height: 100%; margin: 0; font-family: var(--font); background: var(--color-black); color: var(--color-white); }

    .app { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

    /* Header */
    .header { position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-fixed); display: flex; align-items: center; justify-content: center; gap: var(--spacing-lg); padding: var(--spacing-md) var(--spacing-lg); background: rgba(0,0,0,.7); backdrop-filter: blur(8px); }
    .header .left, .header .right { position: absolute; top: 50%; transform: translateY(-50%); }
    .header .left { left: var(--spacing-lg); }
    .header .right { right: var(--spacing-lg); }
    .brand-dot { width: 40px; height: 40px; border-radius: 50%; background: #000; display: grid; place-items: center; }
    .brand-dot img { width: 26px; height: 26px; object-fit: contain; filter: invert(1); }
    .title { margin: 0; font-weight: 600; font-size: 1rem; text-align: center; }

    /* Model Viewer fills screen under header */
    model-viewer { width: 100%; height: 100%; display: block; background: var(--color-black); --poster-color: transparent; }

    /* Floating size controls */
    .panel { position: absolute; left: 50%; bottom: 6rem; transform: translateX(-50%); background: rgba(0,0,0,.75); border: 1px solid rgba(255,255,255,.2); backdrop-filter: blur(8px); padding: var(--spacing-lg); border-radius: var(--radius-md); text-align: center; z-index: var(--z-fixed); min-width: 280px; }
    .panel h3 { margin: 0 0 .5rem; font-size: .95rem; font-weight: 600; }
    .panel label { display:block; font-size: .85rem; opacity: .85; margin-bottom: .25rem; }
    input[type="range"] { width: 100%; height: 6px; background: rgba(255,255,255,.2); border-radius: 999px; -webkit-appearance: none; appearance: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #fff; }
    .buttons { display:flex; gap: .5rem; justify-content:center; margin-top: .5rem; }
    .btn { background: rgba(255,255,255,.12); color: #fff; border: 1px solid rgba(255,255,255,.25); padding: .45rem .7rem; border-radius: 8px; font-size: .8rem; cursor: pointer; }
    .btn.active { background:#fff; color:#000; }

    /* AR button (slotted) visual boost */
    .ar-cta { position: absolute; right: var(--spacing-lg); bottom: var(--spacing-lg); z-index: var(--z-fixed); }
    .ar-cta .btn { background:#fff; color:#000; border:none; box-shadow: 0 8px 20px rgba(0,0,0,.35); }

    /* Tap to play button */
    .play-cta { position: absolute; bottom: 2.5rem; left: 50%; transform: translateX(-50%); z-index: calc(var(--z-fixed) + 1); display: flex; justify-content: center; opacity: 0; transition: opacity 0.4s ease; pointer-events: none; }
    .play-cta.visible { opacity: 1; pointer-events: auto; }
    .play-button { background: rgba(0,0,0,0.75); color: #fff; border: 1px solid rgba(255,255,255,0.35); border-radius: 999px; padding: 0.65rem 1.5rem; font-size: 0.9rem; letter-spacing: 0.03em; text-transform: uppercase; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.4); backdrop-filter: blur(8px); }
    .play-button:active { transform: scale(0.97); }

    /* Loader */
    .loader { position:absolute; inset:0; display:grid; place-items:center; background: rgba(0,0,0,.8); z-index: var(--z-fixed); }
    .loader-inner { text-align:center; padding: 1rem 1.25rem; border: 1px solid rgba(255,255,255,.2); border-radius: 12px; background: rgba(0,0,0,.6); }
    .loader-inner img { width: 64px; height:64px; display:block; margin: 0 auto .75rem; filter: invert(1); }

    /* Multi-model controls */
    .model-controls { position: absolute; right: var(--spacing-lg); top: 4rem; background: rgba(0,0,0,.8); padding: var(--spacing-md); border-radius: var(--radius-md); z-index: var(--z-fixed); min-width: 200px; }
    .model-controls h4 { margin: 0 0 .5rem; font-size: .9rem; }
    .model-list { max-height: 200px; overflow-y: auto; }
    .model-item { display: flex; align-items: center; gap: .5rem; padding: .25rem 0; }
    .model-item input[type="checkbox"] { margin: 0; }
    .model-item label { font-size: .8rem; cursor: pointer; flex: 1; }
    
    /* Animation controls */
    .animation-panel { position: absolute; left: var(--spacing-lg); bottom: 6rem; background: rgba(0,0,0,.8); padding: var(--spacing-md); border-radius: var(--radius-md); z-index: var(--z-fixed); min-width: 220px; }
    .animation-panel h4 { margin: 0 0 .5rem; font-size: .9rem; }
    .animation-btn { display: block; width: 100%; margin-bottom: .5rem; }
    
    /* Debug info */
    .debug-info { position: absolute; top: 4rem; left: var(--spacing-lg); background: rgba(0,0,0,.6); padding: var(--spacing-sm); border-radius: var(--radius-md); font-size: .75rem; z-index: var(--z-fixed); opacity: 0.7; }
    
    /* Behind wall effect */
    .behind-wall { transform: translateZ(-2px) scale(0.8); opacity: 0.6; transition: all 0.8s ease-out; }
    .slide-forward { transform: translateZ(0) scale(1); opacity: 1; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="left">
        <div class="brand-dot"><img src="/assets/lcse-logo-AR-loader.png" alt="LCS+E"></div>
      </div>
      <h1 class="title">Mural AR Experience</h1>
      <div class="right"></div>
    </header>

    <!-- Loader -->
    <div class="loader" id="loader">
      <div class="loader-inner">
        <img src="/assets/lcse-logo-AR-loader.png" alt="Loading" />
        <div id="loadingText">Loading 3D models‚Ä¶</div>
      </div>
    </div>

    <!-- Model Viewer (single source of truth) -->
    <model-viewer
      id="mv"
      src="/assets/models/LCSE-AR-back-animated.glb"
      alt="LCS+E Street Sign - Interactive 3D Model"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-scale="auto"
      camera-controls
      auto-rotate
      environment-image="neutral"
      poster="/assets/lcse-logo-AR-loader.png"
      exposure="1.0"
      camera-orbit="0deg 75deg 100%"
      camera-target="auto"
      xr-environment>
      <!-- Slotted AR button so browsers allow AR -->
      <div slot="ar-button" class="ar-cta"><button class="btn" id="arBtn">üëÅÔ∏è View in AR</button></div>
    </model-viewer>

    <div class="play-cta" id="playCta">
      <button class="play-button" id="playButton" type="button">Tap to Play</button>
    </div>

    <!-- Multi-model controls -->
    <div class="model-controls" id="modelControls" style="display:none;">
      <h4>3D Objects</h4>
      <div class="model-list" id="modelList"></div>
    </div>
    
    <!-- Animation controls -->
    <div class="animation-panel" id="animationPanel" style="display:none;">
      <h4>Scene Animations</h4>
      <button class="btn animation-btn" id="revealBtn">üé≠ Reveal from Behind Wall</button>
      <button class="btn animation-btn" id="hideBtn">üö™ Hide Behind Wall</button>
      <button class="btn animation-btn" id="scatterBtn">üí• Scatter Objects</button>
      <button class="btn animation-btn" id="resetBtn">üîÑ Reset Scene</button>
    </div>

    <!-- Size controls -->
    <div class="panel" id="panel" style="display:none;">
      <h3>Adjust Model Size</h3>
      <label>Scale: <span id="scaleVal">1.0x</span></label>
      <input type="range" id="scale" min="0.1" max="3.0" step="0.1" value="1.0" />
      <div class="buttons">
        <button class="btn" data-scale="0.5">Small</button>
        <button class="btn active" data-scale="1.0">Normal</button>
        <button class="btn" data-scale="2.0">Large</button>
      </div>
    </div>
    
    <!-- Debug info -->
    <div class="debug-info" id="debugInfo" style="display:none;">
      <div>Models loaded: <span id="modelCount">1</span></div>
      <div>Active animations: <span id="animationCount">0</span></div>
      <div>Motion detected: <span id="motionStatus">No</span></div>
    </div>
  </div>

  <script>
    // Enhanced AR Scene Manager
    class MuralARExperience {
      constructor() {
        this.mv = document.getElementById('mv');
        this.loader = document.getElementById('loader');
        this.panel = document.getElementById('panel');
        this.modelControls = document.getElementById('modelControls');
        this.animationPanel = document.getElementById('animationPanel');
        this.debugInfo = document.getElementById('debugInfo');
        this.playCta = document.getElementById('playCta');
        this.playButton = document.getElementById('playButton');
        
        this.scale = document.getElementById('scale');
        this.scaleVal = document.getElementById('scaleVal');
        this.buttons = [...document.querySelectorAll('.buttons .btn')];
        
        this.loadedModels = [];
        this.modelViewers = [];
        this.animationQueue = [];
        this.motionDetected = false;
        this.lastCameraUpdate = 0;
        this.primaryAnimation = null;
        this.playButtonTimer = null;
        this.isAnimationPlaying = false;
        
        this.models = [
          { name: 'Street Sign', src: '/assets/models/cleangreenmid-scaled.glb', position: [0, 0, 0], active: true },
          // Placeholder for graffiti models - you'll add these
          { name: 'Graffiti Piece 1', src: '/assets/models/graffiti1.glb', position: [-1, 0.5, -0.5], active: false },
          { name: 'Graffiti Piece 2', src: '/assets/models/graffiti2.glb', position: [1, -0.2, -0.8], active: false },
          { name: 'Cinderblock', src: '/assets/models/cinderblock.glb', position: [-0.8, -0.5, 0.2], active: false },
          { name: 'Chainlink Fence', src: '/assets/models/fence.glb', position: [0, 0, -2], active: false }
        ];
        
        this.init();
      }
      
      init() {
        console.log('üéØ Initializing Mural AR Experience...');
        this.setupEventListeners();
        this.createModelControls();
        this.startMotionDetection();
      }
      
      setupEventListeners() {
        // Main model viewer events
        this.mv.addEventListener('load', () => {
          this.hideLoader();
          this.showControls();
          this.prepareMuralAnimation();
          console.log('‚úÖ Primary model loaded');
        });
        
        this.mv.addEventListener('error', (e) => {
          console.error('‚ùå Model error:', e);
          document.getElementById('loadingText').textContent = 'Error loading model';
        });
        
        // AR mode events
        this.mv.addEventListener('ar-status', (e) => {
          if (e.detail.status === 'session-started') {
            console.log('üöÄ AR session started');
            this.onARStart();
          }
        });
        
        // Scale controls
        this.scale.addEventListener('input', (e) => this.applyScale(e.target.value));
        this.buttons.forEach(b => b.addEventListener('click', () => {
          this.scale.value = b.dataset.scale;
          this.applyScale(b.dataset.scale);
        }));
        
        // Animation controls
        document.getElementById('revealBtn').addEventListener('click', () => this.revealFromWall());
        document.getElementById('hideBtn').addEventListener('click', () => this.hideInWall());
        document.getElementById('scatterBtn').addEventListener('click', () => this.scatterObjects());
        document.getElementById('resetBtn').addEventListener('click', () => this.resetScene());

        if (this.playButton) {
          this.playButton.addEventListener('click', () => this.playMuralAnimation());
        }

        this.mv.addEventListener('animation-finished', () => this.onAnimationFinished());
      }
      
      hideLoader() {
        setTimeout(() => {
          this.loader.style.display = 'none';
        }, 1000);
      }
      
      showControls() {
        this.panel.style.display = 'block';
        this.modelControls.style.display = 'block';
        this.animationPanel.style.display = 'block';
        this.debugInfo.style.display = 'block';
      }
      
      createModelControls() {
        const modelList = document.getElementById('modelList');
        this.models.forEach((model, index) => {
          const item = document.createElement('div');
          item.className = 'model-item';
          item.innerHTML = `
            <input type="checkbox" id="model-${index}" ${model.active ? 'checked' : ''}>
            <label for="model-${index}">${model.name}</label>
          `;
          
          const checkbox = item.querySelector('input');
          checkbox.addEventListener('change', (e) => {
            this.toggleModel(index, e.target.checked);
          });
          
          modelList.appendChild(item);
        });
      }
      
      toggleModel(index, show) {
        const model = this.models[index];
        model.active = show;
        
        if (show && !this.modelViewers[index]) {
          this.loadModel(index);
        } else if (this.modelViewers[index]) {
          this.modelViewers[index].style.display = show ? 'block' : 'none';
        }
        
        this.updateDebugInfo();
      }
      
      async loadModel(index) {
        const model = this.models[index];
        console.log(`üé® Loading ${model.name}...`);
        
        if (index === 0) return; // Skip primary model (already loaded)
        
        // For now, we'll simulate additional models by duplicating the main viewer
        // In production, you'd create actual separate model-viewer elements
        const viewer = this.mv.cloneNode(true);
        viewer.id = `mv-${index}`;
        viewer.src = model.src;
        viewer.style.position = 'absolute';
        viewer.style.transform = `translate3d(${model.position[0] * 50}px, ${model.position[1] * 50}px, ${model.position[2] * 10}px)`;
        viewer.classList.add('behind-wall');
        
        document.querySelector('.app').appendChild(viewer);
        this.modelViewers[index] = viewer;
        
        // Add to loaded models count
        this.loadedModels.push(model);
        this.updateDebugInfo();
      }
      
      // Animation methods
      revealFromWall() {
        console.log('üé≠ Revealing objects from behind wall...');
        this.modelViewers.forEach((viewer, index) => {
          if (viewer && viewer.style.display !== 'none') {
            viewer.classList.remove('behind-wall');
            viewer.classList.add('slide-forward');
          }
        });
        this.updateAnimationCount(1);
      }
      
      hideInWall() {
        console.log('üö™ Hiding objects behind wall...');
        this.modelViewers.forEach((viewer, index) => {
          if (viewer && viewer.style.display !== 'none') {
            viewer.classList.remove('slide-forward');
            viewer.classList.add('behind-wall');
          }
        });
        this.updateAnimationCount(1);
      }
      
      scatterObjects() {
        console.log('üí• Scattering objects...');
        this.modelViewers.forEach((viewer, index) => {
          if (viewer && viewer.style.display !== 'none') {
            const randomX = (Math.random() - 0.5) * 200;
            const randomY = (Math.random() - 0.5) * 200;
            viewer.style.transform += ` translate(${randomX}px, ${randomY}px)`;
            viewer.style.transition = 'transform 1.5s ease-out';
          }
        });
        this.updateAnimationCount(1);
      }
      
      resetScene() {
        console.log('üîÑ Resetting scene...');
        this.models.forEach((model, index) => {
          if (this.modelViewers[index]) {
            const viewer = this.modelViewers[index];
            viewer.style.transform = `translate3d(${model.position[0] * 50}px, ${model.position[1] * 50}px, ${model.position[2] * 10}px)`;
            viewer.classList.remove('slide-forward', 'behind-wall');
            viewer.classList.add('behind-wall');
          }
        });
        this.updateAnimationCount(0);
      }

      prepareMuralAnimation() {
        const animations = this.mv.availableAnimations || [];
        if (!animations.length) {
          console.warn('‚ö†Ô∏è No animations detected on primary model');
          this.primaryAnimation = null;
          this.hidePlayButton(true);
          if (this.playCta) {
            this.playCta.style.display = 'none';
          }
          return;
        }

        this.primaryAnimation = animations[0];
        this.mv.animationName = this.primaryAnimation;
        this.mv.pause();
        this.mv.currentTime = 0;
        this.showPlayButton();
      }

      async playMuralAnimation() {
        if (!this.primaryAnimation || this.isAnimationPlaying) {
          return;
        }

        this.isAnimationPlaying = true;
        this.hidePlayButton();

        try {
          this.mv.animationName = this.primaryAnimation;
          this.mv.currentTime = 0;
          await this.mv.play({ repetitions: 1, animationName: this.primaryAnimation });
        } catch (error) {
          console.error('‚ùå Unable to play mural animation:', error);
          this.isAnimationPlaying = false;
          this.showPlayButton();
        }
      }

      onAnimationFinished() {
        this.isAnimationPlaying = false;
        if (this.primaryAnimation) {
          this.mv.pause();
          this.mv.currentTime = 0;
        }
        this.showPlayButton();
      }

      showPlayButton() {
        if (!this.playCta) return;
        clearTimeout(this.playButtonTimer);
        if (this.playButton) {
          this.playButton.disabled = false;
        }
        this.playCta.style.display = 'flex';
        this.playButtonTimer = setTimeout(() => {
          this.playCta.classList.add('visible');
        }, 150);
      }

      hidePlayButton(force = false) {
        if (!this.playCta) return;
        clearTimeout(this.playButtonTimer);
        if (this.playButton) {
          this.playButton.disabled = true;
        }
        if (force) {
          this.playCta.classList.remove('visible');
          this.playCta.style.display = 'none';
          return;
        }
        requestAnimationFrame(() => {
          this.playCta.classList.remove('visible');
        });
      }

      onARStart() {
        // Trigger initial "behind wall" setup when AR starts
        setTimeout(() => {
          this.hideInWall();
        }, 1000);
        
        // Start motion-triggered reveals
        this.startARMotionDetection();
      }
      
      startMotionDetection() {
        // Basic motion detection using device orientation
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', (e) => {
            this.handleMotion(e.gamma, e.beta, e.alpha);
          });
        }
      }
      
      startARMotionDetection() {
        // Enhanced motion detection for AR mode
        let motionThreshold = 10;
        let lastOrientation = { x: 0, y: 0, z: 0 };
        
        window.addEventListener('deviceorientation', (e) => {
          const movement = Math.abs(e.gamma - lastOrientation.x) + 
                         Math.abs(e.beta - lastOrientation.y);
          
          if (movement > motionThreshold) {
            this.triggerMotionAnimation();
            document.getElementById('motionStatus').textContent = 'Yes';
          } else {
            document.getElementById('motionStatus').textContent = 'No';
          }
          
          lastOrientation = { x: e.gamma, y: e.beta, z: e.alpha };
        });
      }
      
      handleMotion(x, y, z) {
        // Basic motion handling for preview mode
        const movement = Math.abs(x) + Math.abs(y);
        if (movement > 15) {
          this.motionDetected = true;
          document.getElementById('motionStatus').textContent = 'Yes';
        } else {
          this.motionDetected = false;
          document.getElementById('motionStatus').textContent = 'No';
        }
      }
      
      triggerMotionAnimation() {
        // Randomly trigger reveal animations based on motion
        if (Math.random() > 0.8) { // 20% chance per motion event
          this.revealFromWall();
        }
      }
      
      applyScale(s) {
        this.mv.scale = `${s} ${s} ${s}`;
        this.scaleVal.textContent = `${Number(s).toFixed(1)}x`;
        this.buttons.forEach(b => b.classList.toggle('active', b.dataset.scale === String(s)));
        
        // Apply scale to additional models
        this.modelViewers.forEach(viewer => {
          if (viewer) viewer.scale = `${s} ${s} ${s}`;
        });
      }
      
      updateDebugInfo() {
        document.getElementById('modelCount').textContent = this.loadedModels.length + 1;
      }
      
      updateAnimationCount(count) {
        document.getElementById('animationCount').textContent = count;
        setTimeout(() => {
          document.getElementById('animationCount').textContent = '0';
        }, 3000);
      }
      
      // Public methods for adding models
      addGraffitiModel(name, src, position = [0, 0, -1]) {
        this.models.push({
          name: name,
          src: src,
          position: position,
          active: false
        });
        this.createModelControls(); // Refresh controls
        console.log(`üé® Added ${name} to model library`);
      }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.muralAR = new MuralARExperience();
      console.log('üéØ Mural AR Experience initialized');
    });
    
    // Helper function for adding models dynamically
    window.addGraffitiPiece = (name, modelPath, x = 0, y = 0, z = -1) => {
      if (window.muralAR) {
        window.muralAR.addGraffitiModel(name, modelPath, [x, y, z]);
      }
    };
  </script>
</body>
</html>
